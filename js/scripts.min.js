!function(){var e,t,n,a,i,o,c,r,s=document.getElementById("counters"),d=document.getElementById("add-counter-btn"),l=document.getElementById("add-counter"),u=document.getElementById("close-modal"),m=document.getElementById("modal-submit"),v=document.getElementById("event-name"),g=document.getElementById("event-date"),f=document.getElementById("event-name-error"),y=document.getElementById("event-date-error"),h=document.getElementById("counter-deleted"),p=document.getElementById("undo-delete"),L=document.getElementById("settings-toggle"),E=document.getElementById("settings"),I=document.getElementById("setting-size-list"),B=document.getElementById("setting-scheme-list"),D=document.getElementById("settings-save"),T=!1;picker=new Pikaday({field:document.getElementById("event-date"),format:"YYYY-MM-D"});var M=function(e,t){e.value="",t.value=""},C=function(e,t){e.classList.remove("active"),t.classList.remove("active")},S=function(e){if(!/^\d{4}\-\d{2}\-\d{1,2}$/.test(e))return!1;var t=e.split("-"),n=parseInt(t[0]),a=parseInt(t[1]),i=parseInt(t[2]);if(n<1e3||n>3e3||a<=0||a>12)return!1;var o=[31,28,31,30,31,30,31,31,30,31,30,31];return(n%400===0||n%100!==0&&n%4===0)&&(o[1]=29),i>0&&i<=o[a-1]},k=function(e){var t=864e5,n=new Date;n.setHours(0,0,0,0),currentISO=n.toISOString();var a=new Date(e).toISOString(),i=new Date(currentISO),o=new Date(a),c={days:null,type:null,original:null};return o>i?(c.days=Math.round((o.getTime()-i.getTime())/t),c.type="Days Until"):(c.days=Math.round((i.getTime()-o.getTime())/t),c.type="Days Since"),0===c.days&&(c.days="Today",c.type="<br />"),c.original=e,c},w=function(){var e=document.getElementsByClassName("counter");if(c={},e.length>0)for(var t=0;t<e.length;t++)e[t].id="counter-"+(t+1),c["counter"+(t+1)]={event:e[t].children[2].innerHTML,original:e[t].children[5].innerHTML}},N=function(e,t,n,a){var i=document.createElement("li");i.classList.add("counter"),i.innerHTML='<div class="counter-move"><a class="counter-mover" data-direction="back" href="#"><i class="fa fa-chevron-left" aria-hidden="true"></i></a><a class="counter-mover" data-direction="forward" href="#"><i class="fa fa-chevron-right" aria-hidden="true"></i></a></div><a class="counter-delete transition" href="#"><i class="fa fa-times" aria-hidden="true"></i></a><h3>'+e+'</h3><span class="event-days">'+t+"</span><p>"+n+'</p><span class="event-original">'+a+'</span><a class="counter-edit transition" href="#">Edit Counter</a>',s.appendChild(i)},b=function(){chrome.storage.sync.remove("counters",function(){chrome.storage.sync.set({counters:c},function(){console.log("Counters updated.")})})},H=function(){chrome.storage.sync.get("counters",function(e){for(var t in e.counters)if(e.counters.hasOwnProperty(t)){var n=e.counters[t],a=k(n.original);N(n.event,a.days,a.type,n.original)}w(),O()})},O=function(){e=document.getElementsByClassName("counter-edit"),t=document.getElementsByClassName("counter-delete"),moveCounters=document.getElementsByClassName("counter-mover");for(var n=0;n<e.length;n++)x(e[n]);for(var a=0;a<t.length;a++)Y(t[a]);for(var i=0;i<moveCounters.length;i++)z(moveCounters[i])},x=function(e){e.addEventListener("click",function(e){e.preventDefault(),o=this.parentNode,T=!0,picker.setMoment(moment(o.children[5].innerHTML)),document.getElementById("modal-header-title").innerHTML="Edit Day Counter",document.getElementById("modal-submit").value="Save Day Counter",document.getElementById("event-name").value=o.children[2].innerHTML,document.getElementById("event-date").value=o.children[5].innerHTML,l.classList.add("active")})},Y=function(e){e.addEventListener("click",function(e){var t=this.parentNode;a=parseInt(t.id.split("-")[1]),n=t.parentNode.removeChild(t),h.classList.add("active"),window.clearTimeout(i),i=window.setTimeout(function(){h.classList.remove("active"),w(),b()},5e3)})},z=function(e){e.addEventListener("click",function(e){var t=this.dataset.direction,n=parseInt(this.parentNode.parentNode.id.split("-")[1]);A(n,t)})},A=function(e,t){var n=document.getElementById("counter-"+(e+1)),a=document.getElementById("counter-"+(e-1)),i=document.getElementById("counter-"+e);null===a&&"back"===t||null===n&&"forward"===t||("forward"===t?n.parentNode.insertBefore(i,n.nextSibling):a.parentNode.insertBefore(i,a),w(),b())},P=function(){chrome.storage.sync.get("settings",function(e){I.value=e.settings.counterSize,B.value=e.settings.counterScheme,document.body.className=B.value,s.className=I.value})},U=function(){chrome.storage.sync.remove("settings",function(){chrome.storage.sync.set({settings:r},function(){console.log("Settings updated."),P()})})},$=function(){H(),P(),d.addEventListener("click",function(e){picker.gotoDate(new Date),e.preventDefault(),l.classList.add("active"),document.getElementById("modal-header-title").innerHTML="Add a New Day Counter",document.getElementById("modal-submit").value="Add Day Counter",document.body.classList.add("active")}),u.addEventListener("click",function(e){e.preventDefault(),l.classList.remove("active"),M(v,g),C(f,y),document.body.classList.remove("active")}),m.addEventListener("click",function(){var e=v.value,t=g.value,n=!1;if(""===e||null===e?(f.classList.add("active"),n=!0):f.classList.remove("active"),""!==t&&null!==t&&S(t)?y.classList.remove("active"):(y.classList.add("active"),n=!0),!n){var a=k(t);T?(o.children[2].innerHTML=e,o.children[3].innerHTML=a.days,o.children[4].innerHTML=a.type,o.children[5].innerHTML=a.original,o=null,T=!1):(N(e,a.days,a.type,a.original),O()),w(),b(),l.classList.remove("active"),document.body.classList.remove("active"),M(v,g),C(f,y)}}),p.addEventListener("click",function(e){if(e.preventDefault(),null!==n&&a>0){if(1==a)s.prepend(n);else{var t=document.getElementById("counter-"+(a-1));t.nextSibling?t.parentNode.insertBefore(n,t.nextSibling):s.appendChild(n)}h.classList.remove("active"),n=null,a=null}}),L.addEventListener("click",function(){this.classList.contains("active")?(this.classList.remove("active"),E.classList.remove("active")):(this.classList.add("active"),E.classList.add("active"))}),D.addEventListener("click",function(e){e.preventDefault(),r={},r.counterSize=I.options[I.selectedIndex].value,r.counterScheme=B.options[B.selectedIndex].value,U()})};document.addEventListener("DOMContentLoaded",function(){$()})}();